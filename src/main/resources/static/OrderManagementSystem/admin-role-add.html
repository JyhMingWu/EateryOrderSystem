<!--_meta 作为公共模版分离出去-->
<!DOCTYPE HTML>
<html>
<head>
<meta charset="utf-8">
<meta name="renderer" content="webkit|ie-comp|ie-stand">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
<link rel="Bookmark" href="/favicon.ico" >
<link rel="Shortcut Icon" href="/favicon.ico" />
<!--[if lt IE 9]>
<script type="text/javascript" src="lib/html5shiv.js"></script>
<script type="text/javascript" src="lib/respond.min.js"></script>
<![endif]-->
<link rel="stylesheet" type="text/css" href="static/h-ui/css/H-ui.min.css" />
<link rel="stylesheet" type="text/css" href="static/h-ui.admin/css/H-ui.admin.css" />
<link rel="stylesheet" type="text/css" href="lib/Hui-iconfont/1.0.8/iconfont.css" />
<link rel="stylesheet" type="text/css" href="static/h-ui.admin/skin/default/skin.css" id="skin" />
<link rel="stylesheet" type="text/css" href="static/h-ui.admin/css/style.css" />
<!--[if IE 6]>
<script type="text/javascript" src="lib/DD_belatedPNG_0.0.8a-min.js" ></script>
<script>DD_belatedPNG.fix('*');</script>
<![endif]-->
<!--/meta 作为公共模版分离出去-->

<title>新建网站角色 - 管理员管理 - H-ui.admin 3.0</title>
<meta name="keywords" content="H-ui.admin 3.0,H-ui网站后台模版,后台模版下载,后台管理系统模版,HTML后台模版下载">
<meta name="description" content="H-ui.admin 3.0，是一款由国人开发的轻量级扁平化网站后台模板，完全免费开源的网站后台管理系统模版，适合中小型CMS后台系统。">
</head>
<body>
<article class="page-container">
	<div class="form form-horizontal" id="form-admin-role-add">
		<div class="row cl">
			<label class="form-label col-xs-4 col-sm-3"><span class="c-red">*</span>角色名称：</label>
			<div class="formControls col-xs-8 col-sm-9">
				<input type="text" class="input-text" value="" placeholder="" id="role_name" name="roleName">
			</div>
		</div>
		<div class="row cl">
			<label class="form-label col-xs-4 col-sm-3">备注：</label>
			<div class="formControls col-xs-8 col-sm-9">
				<input type="text" class="input-text" value="" placeholder="" id="description" name="">
			</div>
		</div>
		<div class="row cl">
			<label class="form-label col-xs-4 col-sm-3">网站角色：</label>
			<div class="formControls col-xs-8 col-sm-9">
				<dl class="permission-list">
					<dt>
						<label>
							<!--<input type="checkbox" value="" name="user-Character-0" id="user-Character-0">-->
							操作管理</label>
					</dt>
					<dd id="caozuo">
						<dl class="cl permission-list2">
							<dt>
								<label class="">
									<!--<input type="checkbox" value="" name="user-Character-0-0" id="user-Character-0-0">-->
									高级管理</label>
							</dt>
							<dd id="High">
							</dd>
						</dl>
						<dl class="cl permission-list2">
							<dt>
								<label class="">
									<!--<input type="checkbox" value="" name="user-Character-0-0" id="user-Character-0-0">-->
									新闻管理</label>
							</dt>
							<dd id="New">
							</dd>
						</dl>
						<dl class="cl permission-list2">
							<dt>
								<label class="">
									<!--<input type="checkbox" value="" name="user-Character-0-1" id="user-Character-0-1">-->
									排行榜管理</label>
							</dt>
							<dd id="Rank">
							</dd>
						</dl>
						<dl class="cl permission-list2">
							<dt>
								<label class="">
									<!--<input type="checkbox" value="" name="user-Character-0-1" id="user-Character-0-2">-->
									联盟管理</label>
							</dt>
							<dd id="Alliance">
							</dd>
						</dl>
						<dl class="cl permission-list2">
							<dt>
								<label class="">
									<!--<input type="checkbox" value="" name="user-Character-0-1" id="user-Character-0-2">-->
									轮播图管理</label>
							</dt>
							<dd id="Carousel">
							</dd>
						</dl>
					</dd>
				</dl>
				<dl class="permission-list">
					<dt>
						<label>
							<!--<input type="checkbox" value="" name="user-Character-0" id="user-Character-1">-->
							用户中心</label>
					</dt>
					<dd id="yonghu">
						<dl class="cl permission-list2">
							<dt>
								<label class="">
									<!--<input type="checkbox" value="" name="user-Character-1-0" id="user-Character-1-1">-->
									用户管理</label>
							</dt>
							<dd id="user">
							</dd>
						</dl>
						<dl class="cl permission-list2">
							<dt>
								<label class="">
									<!--<input type="checkbox" value="" name="user-Character-1-0" id="user-Character-1-2">-->
									角色</label>
							</dt>
							<dd id="role">
							</dd>
						</dl>
					</dd>
				</dl>
			</div>
		</div>
		<div class="row cl">
			<div class="col-xs-8 col-sm-9 col-xs-offset-4 col-sm-offset-3">
				<button type="submit" class="btn btn-success radius" id="admin-role-save" name="admin-role-save" onclick="Submit()"><i class="icon-ok"></i> 确定</button>
			</div>
		</div>
	</div>
</article>

<!--_footer 作为公共模版分离出去-->
<script type="text/javascript" src="lib/jquery/1.9.1/jquery.min.js"></script> 
<script type="text/javascript" src="lib/layer/2.4/layer.js"></script>
<script type="text/javascript" src="static/h-ui/js/H-ui.min.js"></script> 
<script type="text/javascript" src="static/h-ui.admin/js/H-ui.admin.js"></script>
<!--/_footer 作为公共模版分离出去-->

<!--请在下方写此页面业务相关的脚本-->
<script type="text/javascript" src="lib/jquery.validation/1.14.0/jquery.validate.js"></script>
<script type="text/javascript" src="lib/jquery.validation/1.14.0/validate-methods.js"></script>
<script type="text/javascript" src="lib/jquery.validation/1.14.0/messages_zh.js"></script>
<script type="text/javascript">
    var edit="";
$(function(){

    edit=getUrlParam("edit");

	$(".permission-list dt input:checkbox").click(function(){
		$(this).closest("dl").find("dd input:checkbox").prop("checked",$(this).prop("checked"));
	});
	$(".permission-list2 dd input:checkbox").click(function(){
		var l =$(this).parent().parent().find("input:checked").length;
		var l2=$(this).parents(".permission-list").find(".permission-list2 dd").find("input:checked").length;
		if($(this).prop("checked")){
			$(this).closest("dl").find("dt input:checkbox").prop("checked",true);
			$(this).parents(".permission-list").find("dt").first().find("input:checkbox").prop("checked",true);
		}
		else{
			if(l==0){
				$(this).closest("dl").find("dt input:checkbox").prop("checked",false);
			}
			if(l2==0){
				$(this).parents(".permission-list").find("dt").first().find("input:checkbox").prop("checked",false);
			}
		}
	});

	$("#form-admin-role-add").validate({
		rules:{
			roleName:{
				required:true,
			},
		},
		onkeyup:false,
		focusCleanup:true,
		success:"valid",
		submitHandler:function(form){
			$(form).ajaxSubmit();
			var index = parent.layer.getFrameIndex(window.name);
			parent.layer.close(index);
		}
	});

    $.ajax({
        type: 'GET',
        url: 'http://localhost:8080/Authority/GetAllSysPermission',
        dataType: 'json',
        beforeSend: function(request) {
            request.setRequestHeader("Access-Token", localStorage.getItem("user_token"));
        },
		async:false,//同步执行
        success: function(data){
            var High="";
            var New="";
            var Rank="";
            var Alliance="";
            var user="";
            var role="";
            var Carousel="";
            for(var i=0;i<data['Data'].length;i++){
                //高级管理
                if(data['Data'][i]['type']==0){
                    High+='<label class=""><input type="checkbox" value="'+data['Data'][i]['id']+'" name="user-Character-0-0-0" id="'+data['Data'][i]['id']+'">'+data['Data'][i]['name']+'</label>';
                }
                //新闻
                if(data['Data'][i]['type']==1){
                    New+='<label class=""><input type="checkbox" value="'+data['Data'][i]['id']+'" name="user-Character-0-0-0" id="'+data['Data'][i]['id']+'">'+data['Data'][i]['name']+'</label>';
                }
                //排行榜
                if(data['Data'][i]['type']==2){
                    Rank+='<label class=""><input type="checkbox" value="'+data['Data'][i]['id']+'" name="user-Character-0-0-0" id="'+data['Data'][i]['id']+'">'+data['Data'][i]['name']+'</label>';
                }
                //联盟
                if(data['Data'][i]['type']==3){
                    Alliance+='<label class=""><input type="checkbox" value="'+data['Data'][i]['id']+'" name="user-Character-0-0-0" id="'+data['Data'][i]['id']+'">'+data['Data'][i]['name']+'</label>';
                }
                //用户管理
                if(data['Data'][i]['type']==4){
                    user+='<label class=""><input type="checkbox" value="'+data['Data'][i]['id']+'" name="user-Character-0-0-0" id="'+data['Data'][i]['id']+'">'+data['Data'][i]['name']+'</label>';
                }
                //角色
                if(data['Data'][i]['type']==5){
                    role+='<label class=""><input type="checkbox" value="'+data['Data'][i]['id']+'" name="user-Character-0-0-0" id="'+data['Data'][i]['id']+'">'+data['Data'][i]['name']+'</label>';
                }
                //轮播图
                if(data['Data'][i]['type']==6){
                    Carousel+='<label class=""><input type="checkbox" value="'+data['Data'][i]['id']+'" name="user-Character-0-0-0" id="'+data['Data'][i]['id']+'">'+data['Data'][i]['name']+'</label>';
                }
            }
            $("#High").append(High);
            $("#New").append(New);
            $("#Rank").append(Rank);
            $("#Alliance").append(Alliance);
            $("#user").append(user);
            $("#role").append(role);
            $("#Carousel").append(Carousel);
        },
        error: function(xhr, exception){
            if( xhr.status === 0)
                alert('Error : ' + xhr.status + 'You are not connected.');
            else if( xhr.status == "403"){
                layer.alert('在线超时，认证已无效，请重新登录', {
                        skin: 'layui-layer-lan' //样式类名
                        ,closeBtn: 0
                    }, function(){
                        localStorage.removeItem("user_token");
                        localStorage.removeItem("real_name");
                        localStorage.removeItem("user_name");
                        parent.window.location.href="login.html";
                    });
            }
            else if( xhr.status == "401"){
                var jsonResponse = JSON.parse(xhr.responseText);
                layer.msg(jsonResponse['msg'], {icon:5,time:1500});
                setTimeout(function () {
                    var index = parent.layer.getFrameIndex(window.name);
                    parent.layer.close(index);
                }, 1500);
            }
            else if( xhr.status == "500")
                alert('Internal Server Error [500].');
        }
    });

	if(edit==1){
	    //进来编辑的,获取角色权限
        var roleId=getUrlParam("roleId");
        $.ajax({
            type: 'GET',
            url: 'http://localhost:8080/Authority/GetRoleSysPermission?roleId='+roleId,
            dataType: 'json',
            beforeSend: function(request) {
                request.setRequestHeader("Access-Token", localStorage.getItem("user_token"));
            },
            async:false,//同步执行
            success: function(data){
				for(var i=0;i<data['Data'].length;i++){
				    $('#'+data['Data'][i]['permissionId']+'').attr("checked","checked");
                }
            },
            error: function(xhr, exception){
                if( xhr.status === 0)
                    alert('Error : ' + xhr.status + 'You are not connected.');
                else if( xhr.status == "403"){
                    layer.alert('在线超时，认证已无效，请重新登录', {
                        skin: 'layui-layer-lan' //样式类名
                        ,closeBtn: 0
                    }, function(){
                        localStorage.removeItem("user_token");
                        localStorage.removeItem("real_name");
                        localStorage.removeItem("user_name");
                        parent.window.location.href="login.html";
                    });
                }
                else if( xhr.status == "401"){
                    var jsonResponse = JSON.parse(xhr.responseText);
                    layer.msg(jsonResponse['msg'], {icon:5,time:1500});
                    setTimeout(function () {
                        var index = parent.layer.getFrameIndex(window.name);
                        parent.layer.close(index);
                    }, 1500);
                }
                else if( xhr.status == "500")
                    alert('Internal Server Error [500].');
            }
        });
	}else{
	    //进来新建的
	}

});


//提交
function Submit() {
    //勾选中集合
    var spCodesTemp = "";
    $('input:checkbox[name=user-Character-0-0-0]:checked').each(function(i){
        if(0==i){
            spCodesTemp = $(this).val();
        }else{
            spCodesTemp += (","+$(this).val());
        }
    });
    // var edit=getUrlParam("edit");
    if(edit==1){
        //编辑提交
        $.ajax({
            type: 'POST',
            url: 'http://localhost:8080/Authority/UpdateRoleSysPermission',
            dataType: 'json',
            data:{
                roleId:getUrlParam("roleId"),
                permission:spCodesTemp
            },
            beforeSend: function(request) {
                request.setRequestHeader("Access-Token", localStorage.getItem("user_token"));
            },
            success: function(data){
                if(data['Status']){
                    layer.msg(data['Message'], {icon:6,time:1500});
                    setTimeout(function () {
                        parent.window.location.href="admin-role.html";
                    }, 1500);

                }else{
                    layer.msg(data['Message'], {icon:5,time:1500});
                    setTimeout(function () {
                        parent.window.location.href="admin-role.html";
                        // var index = parent.layer.getFrameIndex(window.name);
                        // parent.layer.close(index);
                    }, 1500);
                }
            },
            error: function(xhr, exception){
                if( xhr.status === 0)
                    alert('Error : ' + xhr.status + 'You are not connected.');
                else if( xhr.status == "403"){
                    layer.alert('在线超时，认证已无效，请重新登录', {
                        skin: 'layui-layer-lan' //样式类名
                        ,closeBtn: 0
                    }, function(){
                        localStorage.removeItem("user_token");
                        localStorage.removeItem("real_name");
                        localStorage.removeItem("user_name");
                        parent.window.location.href="login.html";
                    });
                }
                else if( xhr.status == "401"){
                    var jsonResponse = JSON.parse(xhr.responseText);
                    layer.msg(jsonResponse['msg'], {icon:5,time:1500});
                }
                else if( xhr.status == "500")
                    alert('Internal Server Error [500].');
            }
        });
	}else {
        //新建提交
        $.ajax({
            type: 'POST',
            url: 'http://localhost:8080/Authority/AddRole',
            dataType: 'json',
            data:{
                role_name:$("#role_name").val(),
                description:$("#description").val(),
                permission:spCodesTemp
            },
            beforeSend: function(request) {
                request.setRequestHeader("Access-Token", localStorage.getItem("user_token"));
            },
            success: function(data){
                if(data['Status']){
                    layer.msg(data['Message'], {icon:6,time:1500});
                    setTimeout(function () {
                        parent.window.location.href="admin-role.html";
                        // var index = parent.layer.getFrameIndex(window.name);
                        // parent.layer.close(index);
                        // setTimeout(function () {
                        //     window.location.href="admin-role.html";
                        // }, 500);
                    }, 1500);
                }else{
                    layer.msg(data['Message'], {icon:5,time:1500});
                    setTimeout(function () {
                        parent.window.location.href="admin-role.html";
                        // var index = parent.layer.getFrameIndex(window.name);
                        // parent.layer.close(index);
                        // window.location.href="admin-role.html";
                        // setTimeout(function () {
                        //     window.location.href="admin-role.html";
                        // }, 500);
                    }, 1500);
                }
            },
            error: function(xhr, exception){
                if( xhr.status === 0)
                    alert('Error : ' + xhr.status + 'You are not connected.');
                else if( xhr.status == "403"){
                    layer.alert('在线超时，认证已无效，请重新登录', {
                        skin: 'layui-layer-lan' //样式类名
                        ,closeBtn: 0
                    }, function(){
                        localStorage.removeItem("user_token");
                        localStorage.removeItem("real_name");
                        localStorage.removeItem("user_name");
                        parent.window.location.href="login.html";
                    });
                }
                else if( xhr.status == "401"){
                    var jsonResponse = JSON.parse(xhr.responseText);
                    layer.msg(jsonResponse['msg'], {icon:5,time:1500});
                }
                else if( xhr.status == "500")
                    alert('Internal Server Error [500].');
            }
        });
	}

}

// 获取页面传参参数
function getUrlParam(name) {
    var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
    var r = window.location.search.substr(1).match(reg);
    if (r != null) return unescape(r[2]); return null;
}
</script>
<!--/请在上方写此页面业务相关的脚本-->
</body>
</html>