<!DOCTYPE HTML>
<html>
<head>
<meta charset="utf-8">
<meta name="renderer" content="webkit|ie-comp|ie-stand">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
<!--[if lt IE 9]>
<script type="text/javascript" src="lib/html5shiv.js"></script>
<script type="text/javascript" src="lib/respond.min.js"></script>
<![endif]-->
<link rel="stylesheet" type="text/css" href="static/h-ui/css/H-ui.min.css" />
<link rel="stylesheet" type="text/css" href="static/h-ui.admin/css/H-ui.admin.css" />
<link rel="stylesheet" type="text/css" href="lib/Hui-iconfont/1.0.8/iconfont.css" />
<link rel="stylesheet" type="text/css" href="static/h-ui.admin/skin/default/skin.css" id="skin" />
<link rel="stylesheet" type="text/css" href="static/h-ui.admin/css/style.css" />
<!--[if IE 6]>
<script type="text/javascript" src="lib/DD_belatedPNG_0.0.8a-min.js" ></script>
<script>DD_belatedPNG.fix('*');</script>
<![endif]-->
<title>添加管理员 - 管理员管理 - H-ui.admin v2.4</title>
<meta name="keywords" content="H-ui.admin 3.0,H-ui网站后台模版,后台模版下载,后台管理系统模版,HTML后台模版下载">
<meta name="description" content="H-ui.admin 3.0，是一款由国人开发的轻量级扁平化网站后台模板，完全免费开源的网站后台管理系统模版，适合中小型CMS后台系统。">
</head>
<body>
<article class="page-container">
	<div class="form form-horizontal" id="form-admin-add">
		<div class="row cl">
			<label class="form-label col-xs-4 col-sm-3"><span class="c-red">*</span>管理员：</label>
			<div class="formControls col-xs-8 col-sm-9">
				<input type="text" class="input-text" value="" placeholder="" id="adminName" name="adminName">
			</div>
		</div>

		<div id="hhh">

		</div>
		<!--<div class="row cl" id="csmm">-->
			<!--<label class="form-label col-xs-4 col-sm-3"><span class="c-red">*</span>初始密码：</label>-->
			<!--<div class="formControls col-xs-8 col-sm-9">-->
				<!--<input type="password" class="input-text" autocomplete="off" value="" placeholder="密码" id="password" name="password">-->
			<!--</div>-->
		<!--</div>-->
		<!--<div class="row cl" id="qrmm">-->
			<!--<label class="form-label col-xs-4 col-sm-3"><span class="c-red">*</span>确认密码：</label>-->
			<!--<div class="formControls col-xs-8 col-sm-9">-->
				<!--<input type="password" class="input-text" autocomplete="off"  placeholder="确认新密码" id="password2" name="password2">-->
			<!--</div>-->
		<!--</div>-->
		<!--<div class="row cl">-->
			<!--<label class="form-label col-xs-4 col-sm-3"><span class="c-red">*</span>性别：</label>-->
			<!--<div class="formControls col-xs-8 col-sm-9 skin-minimal">-->
				<!--<div class="radio-box">-->
					<!--<input name="sex" type="radio" id="sex-1" checked>-->
					<!--<label for="sex-1">男</label>-->
				<!--</div>-->
				<!--<div class="radio-box">-->
					<!--<input type="radio" id="sex-2" name="sex">-->
					<!--<label for="sex-2">女</label>-->
				<!--</div>-->
			<!--</div>-->
		<!--</div>-->
		<div class="row cl">
			<label class="form-label col-xs-4 col-sm-3"><span class="c-red">*</span>手机：</label>
			<div class="formControls col-xs-8 col-sm-9">
				<input type="text" class="input-text" value="" placeholder="" id="phone" name="phone">
			</div>
		</div>
		<div class="row cl">
			<label class="form-label col-xs-4 col-sm-3"><span class="c-red">*</span>邮箱：</label>
			<div class="formControls col-xs-8 col-sm-9">
				<input type="text" class="input-text" placeholder="@" name="email" id="email">
			</div>
		</div>
		<div class="row cl">
			<label class="form-label col-xs-4 col-sm-3">角色：</label>
			<div class="formControls col-xs-8 col-sm-9"> <span class="select-box" style="width:150px;">
			<select class="select" name="adminRole" size="1" id="role">
				<!--<option value="0">超级管理员</option>-->
				<!--<option value="1">总编</option>-->
				<!--<option value="2">栏目主辑</option>-->
				<!--<option value="3">栏目编辑</option>-->
			</select>
			</span> </div>
		</div>
		<div class="row cl">
			<label class="form-label col-xs-4 col-sm-3">备注：</label>
			<div class="formControls col-xs-8 col-sm-9">
				<textarea id="describe" name="" cols="" rows="" class="textarea"  placeholder="说点什么...100个字符以内" dragonfly="true" onKeyUp="$.Huitextarealength(this,100)"></textarea>
				<p class="textarea-numberbar"><em class="textarea-length">0</em>/100</p>
			</div>
		</div>
		<div class="row cl">
			<div class="col-xs-8 col-sm-9 col-xs-offset-4 col-sm-offset-3">
				<input class="btn btn-primary radius" type="submit" value="&nbsp;&nbsp;提交&nbsp;&nbsp;" onclick="addUser()">
			</div>
		</div>
	</div>
</article>

<!--_footer 作为公共模版分离出去--> 
<script type="text/javascript" src="lib/jquery/1.9.1/jquery.min.js"></script> 
<script type="text/javascript" src="lib/layer/2.4/layer.js"></script>
<script type="text/javascript" src="static/h-ui/js/H-ui.min.js"></script> 
<script type="text/javascript" src="static/h-ui.admin/js/H-ui.admin.js"></script>
<!--/_footer 作为公共模版分离出去-->

<!--请在下方写此页面业务相关的脚本-->
<script type="text/javascript" src="lib/jquery.validation/1.14.0/jquery.validate.js"></script> 
<script type="text/javascript" src="lib/jquery.validation/1.14.0/validate-methods.js"></script> 
<script type="text/javascript" src="lib/jquery.validation/1.14.0/messages_zh.js"></script> 
<script type="text/javascript">
	var edit=getUrlParam("edit");

$(function(){
    $('.skin-minimal input').iCheck({
        checkboxClass: 'icheckbox-blue',
        radioClass: 'iradio-blue',
        increaseArea: '20%'
    });

    $("#form-admin-add").validate({
        rules:{
            adminName:{
                required:true,
                minlength:4,
                maxlength:16
            },
            password:{
                required:true,
            },
            password2:{
                required:true,
                equalTo: "#password"
            },
            sex:{
                required:true,
            },
            phone:{
                required:true,
                isPhone:true,
            },
            email:{
                required:true,
                email:true,
            },
            adminRole:{
                required:true,
            },
        },
        onkeyup:false,
        focusCleanup:true,
        success:"valid",
        submitHandler:function(form){
            $(form).ajaxSubmit({
                type: 'post',
                url: "xxxxxxx" ,
                success: function(data){
                    layer.msg('添加成功!',{icon:1,time:1000});
                },
                error: function(XmlHttpRequest, textStatus, errorThrown){
                    layer.msg('error!',{icon:1,time:1000});
                }
            });
            var index = parent.layer.getFrameIndex(window.name);
            parent.$('.btn-refresh').click();
            parent.layer.close(index);
        }
    });
    SelAllRole();
});

function loads() {
    $('.skin-minimal input').iCheck({
        checkboxClass: 'icheckbox-blue',
        radioClass: 'iradio-blue',
        increaseArea: '20%'
    });

    $("#form-admin-add").validate({
        rules:{
            adminName:{
                required:true,
                minlength:4,
                maxlength:16
            },
            password:{
                required:true,
            },
            password2:{
                required:true,
                equalTo: "#password"
            },
            sex:{
                required:true,
            },
            phone:{
                required:true,
                isPhone:true,
            },
            email:{
                required:true,
                email:true,
            },
            adminRole:{
                required:true,
            },
        },
        onkeyup:false,
        focusCleanup:true,
        success:"valid",
        submitHandler:function(form){
            $(form).ajaxSubmit({
                type: 'post',
                url: "xxxxxxx" ,
                success: function(data){
                    layer.msg('添加成功!',{icon:1,time:1000});
                },
                error: function(XmlHttpRequest, textStatus, errorThrown){
                    layer.msg('error!',{icon:1,time:1000});
                }
            });
            var index = parent.layer.getFrameIndex(window.name);
            parent.$('.btn-refresh').click();
            parent.layer.close(index);
        }
    });
}



//添加新用户/修改
function addUser() {
	var user_name=$("#adminName").val();
    var password=$("#password").val();
    var phone=$("#phone").val();
    var email=$("#email").val();
    var describe=$("#describe").val();
    var real_name=$("#role").val();
    var role_id=$("#role").val();

    if(edit==1){
        //这是编辑
        $.ajax({
            type: 'POST',
            url: 'http://localhost:8080/SysUser/UpdateUserInfo',
            dataType: 'json',
            data:{
                id:getUrlParam("id"),
                user_name:user_name,
                // password:password,
                phone:phone,
                email:email,
                describe:describe,
                real_name:real_name,
                role_id:role_id,
            },
            beforeSend: function(request) {
                request.setRequestHeader("Access-Token", localStorage.getItem("user_token"));
            },
            success: function(data){
                if(data['Status']){
                    layer.msg(data['Message'], {icon:6,time:1500});
                    setTimeout(function () {
                        // var index = parent.layer.getFrameIndex(window.name);
                        // parent.layer.close(index);
                        parent.window.location.href="admin-list.html";
                    }, 1500);
                }else{
                    layer.msg(data['Message'], {icon:5,time:1500});
                    setTimeout(function () {
                        // var index = parent.layer.getFrameIndex(window.name);
                        // parent.layer.close(index);
                        parent.window.location.href="admin-list.html";
                    }, 1500);
                }
            },
            error: function(xhr, exception){
                if( xhr.status === 0)
                    alert('Error : ' + xhr.status + 'You are not connected.');
                else if( xhr.status == "403"){
                    alert('token错误或失效，请重新登录 : ' + xhr.status + '\n-->'+ xhr.responseText);
                    localStorage.removeItem("user_token");
                    localStorage.removeItem("real_name");
                    localStorage.removeItem("user_name");
                    parent.parent.window.location.href="login.html";
                }
                else if( xhr.status == "401"){
                    var jsonResponse = JSON.parse(xhr.responseText);
                    layer.msg(jsonResponse['msg'], {icon:5,time:1500});
                }
                else if( xhr.status == "500")
                    alert('Internal Server Error [500].');
            }
        });
	}else{
        //这是新增
        $.ajax({
            type: 'POST',
            url: 'http://localhost:8080/SysUser/AddUser',
            dataType: 'json',
            data:{
                user_name:user_name,
                password:password,
                phone:phone,
                email:email,
                describe:describe,
                real_name:real_name,
                role_id:role_id,
            },
            beforeSend: function(request) {
                request.setRequestHeader("Access-Token", localStorage.getItem("user_token"));
            },
            success: function(data){
                if(data['Status']){
                    layer.msg(data['Message'], {icon:6,time:1500});
                    setTimeout(function () {
                        // var index = parent.layer.getFrameIndex(window.name);
                        // parent.layer.close(index);
                        parent.window.location.href="admin-list.html";
                    }, 1500);
                }else{
                    layer.msg(data['Message'], {icon:5,time:1500});
                    setTimeout(function () {
                        // var index = parent.layer.getFrameIndex(window.name);
                        // parent.layer.close(index);
                        parent.window.location.href="admin-list.html";
                    }, 1500);
                }
            },
            error: function(xhr, exception){
                if( xhr.status === 0)
                    alert('Error : ' + xhr.status + 'You are not connected.');
                else if( xhr.status == "403"){
                    alert('token错误或失效，请重新登录 : ' + xhr.status + '\n-->'+ xhr.responseText);
                    localStorage.removeItem("user_token");
                    localStorage.removeItem("real_name");
                    localStorage.removeItem("user_name");
                    parent.parent.window.location.href="login.html";
                }
                else if( xhr.status == "401"){
                    var jsonResponse = JSON.parse(xhr.responseText);
                    layer.msg(jsonResponse['msg'], {icon:5,time:1500});
                }
                else if( xhr.status == "500")
                    alert('Internal Server Error [500].');
            }
        });
	}



}

//获取所有角色
function SelAllRole() {
    $.ajax({
        type: 'GET',
        url: 'http://localhost:8080/SysUser/SelAllRole',
        dataType: 'json',
		async:true,
        beforeSend: function(request) {
            request.setRequestHeader("Access-Token", localStorage.getItem("user_token"));
        },
        success: function(data){
            if(data['Status']){
				var html="";
				for(var i=0;i<data['Data'].length;i++){
                    html+='<option value="'+data['Data'][i]['id']+','+data['Data'][i]['role_name']+'" id="'+data['Data'][i]['id']+'">'+data['Data'][i]['role_name']+'</option>'
				}
				$("#role").append(html);
                if(edit==1){
                    //这是编辑，进来先获取用户信息
                    $.ajax({
                        type: 'GET',
                        url: 'http://localhost:8080/SysUser/getUserById?id='+getUrlParam("id"),
                        dataType: 'json',
                        async:false,//同步执行
                        beforeSend: function(request) {
                            request.setRequestHeader("Access-Token", localStorage.getItem("user_token"));
                        },
                        success: function(data){
                            if(data['Status']){
                                $("#adminName").val(data['Data']['user_name']);
                                $("#phone").val(data['Data']['phone']);
                                $("#email").val(data['Data']['email']);
                                $("#describe").val(data['Data']['describe']);
                                var s=data['Data']['role_id']+","+data['Data']['real_name'];
                                $('#'+data['Data']['role_id']+'').attr("selected","true");//设置select选中值
                                loads();
                            }else{

                            }
                        },
                        error: function(xhr, exception){
                            if( xhr.status === 0)
                                alert('Error : ' + xhr.status + 'You are not connected.');
                            else if( xhr.status == "403"){
                                layer.alert('在线超时，认证已无效，请重新登录', {
									skin: 'layui-layer-lan' //样式类名
									,closeBtn: 0
								}, function(){
									localStorage.removeItem("user_token");
									localStorage.removeItem("real_name");
									localStorage.removeItem("user_name");
									parent.window.location.href="login.html";
								});
                            }
                            else if( xhr.status == "401"){
                                var jsonResponse = JSON.parse(xhr.responseText);
                                layer.msg(jsonResponse['msg'], {icon:5,time:1500});
                                setTimeout(function () {
                                    var index = parent.layer.getFrameIndex(window.name);
                                    parent.layer.close(index);
                                }, 1500);
                            }
                            else if( xhr.status == "500")
                                alert('Internal Server Error [500].');
                        }
                    });
                }else{
                    //这是新增
                    var mima="";
                    mima+='<div class="row cl" id="csmm"><label class="form-label col-xs-4 col-sm-3"><span class="c-red">*</span>初始密码：</label><div class="formControls col-xs-8 col-sm-9"><input type="password" class="input-text" autocomplete="off" value="" placeholder="密码" id="password" name="password"></div></div><div class="row cl" id="qrmm"><label class="form-label col-xs-4 col-sm-3"><span class="c-red">*</span>确认密码：</label><div class="formControls col-xs-8 col-sm-9"><input type="password" class="input-text" autocomplete="off"  placeholder="确认新密码" id="password2" name="password2"></div></div>';
                	$("#hhh").append(mima);

                }
            }else{
                layer.msg(data['Message'], {icon:5,time:1500});
                setTimeout(function () {
                    var index = parent.layer.getFrameIndex(window.name);
                    parent.layer.close(index);
                    parent.window.location.href="admin-list.html";
                }, 1500);
            }
        },
        error: function(xhr, exception){
            if( xhr.status === 0)
                alert('Error : ' + xhr.status + 'You are not connected.');
            else if( xhr.status == "403"){
                layer.alert('在线超时，认证已无效，请重新登录', {
                        skin: 'layui-layer-lan' //样式类名
                        ,closeBtn: 0
                    }, function(){
                        localStorage.removeItem("user_token");
                        localStorage.removeItem("real_name");
                        localStorage.removeItem("user_name");
                        parent.window.location.href="login.html";
                    });
            }
            else if( xhr.status == "401"){
                var jsonResponse = JSON.parse(xhr.responseText);
                layer.msg(jsonResponse['msg'], {icon:5,time:1500});
            }
            else if( xhr.status == "500")
                alert('Internal Server Error [500].');
        }
    });
}


// 获取页面传参参数
function getUrlParam(name) {
    var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
    var r = window.location.search.substr(1).match(reg);
    if (r != null) return unescape(r[2]); return null;
}
</script> 
<!--/请在上方写此页面业务相关的脚本-->
</body>
</html>